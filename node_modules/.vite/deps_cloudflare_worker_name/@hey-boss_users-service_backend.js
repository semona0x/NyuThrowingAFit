import {
  HTTPException
} from "./chunk-4Q2D6ZNV.js";
import {
  getCookie
} from "./chunk-5A73J7LV.js";
import "./chunk-QGQUDZ4N.js";
import "./chunk-HKJ2B2AA.js";

// node_modules/hono/dist/helper/factory/index.js
var createMiddleware = (middleware) => middleware;

// node_modules/@hey-boss/users-service/dist/backend.js
var DEFAULT_USERS_SERVICE_API_URL = "https://user-server.dev-73d.workers.dev";
var SESSION_TOKEN_COOKIE_NAME = "heyboss_session_token";
var SUPPORTED_OAUTH_PROVIDERS = ["google"];
async function getOAuthRedirectUrl(provider, options) {
  if (!SUPPORTED_OAUTH_PROVIDERS.includes(provider)) {
    throw new Error(`Unsupported OAuth provider: ${provider}`);
  }
  const response = await fetch(`${DEFAULT_USERS_SERVICE_API_URL}/oauth/${provider}/redirect_url?originUrl=${options.originUrl}`, {
    method: "GET",
    headers: {
      "Content-Type": "application/json"
    }
  });
  if (!response.ok) {
    throw new Error(`Failed to get redirect URL for provider ${provider}: ${response.statusText}`);
  }
  const { redirectUrl } = await response.json();
  return redirectUrl;
}
async function exchangeCodeForSessionToken(code, projectId = "") {
  const response = await fetch(`${DEFAULT_USERS_SERVICE_API_URL}/sessions`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ code, projectId })
  });
  if (!response.ok) {
    throw new Error(`Failed to exchange code for session token: ${response.statusText}`);
  }
  const { sessionToken } = await response.json();
  return sessionToken;
}
async function getCurrentUser(sessionToken) {
  const response = await fetch(`${DEFAULT_USERS_SERVICE_API_URL}/users/me`, {
    method: "GET",
    headers: {
      Authorization: `Bearer ${sessionToken}`
    }
  });
  if (!response.ok) {
    return null;
  }
  const { data: user } = await response.json();
  return user;
}
async function deleteSession(sessionToken) {
  await fetch(`${DEFAULT_USERS_SERVICE_API_URL}/sessions`, {
    method: "DELETE",
    headers: {
      Authorization: `Bearer ${sessionToken}`
    }
  });
}
var authMiddleware = createMiddleware(async (c, next) => {
  const sessionToken = getCookie(c, SESSION_TOKEN_COOKIE_NAME);
  if (typeof sessionToken !== "string") {
    return c.json({ error: "Unauthorized" }, 401);
  }
  const user = await getCurrentUser(sessionToken);
  if (!user) {
    throw new HTTPException(401, { message: "Invalid session token" });
  }
  c.set("user", user);
  await next();
});
async function sendOTP(email, projectId) {
  const response = await fetch(`${DEFAULT_USERS_SERVICE_API_URL}/auth/send-otp`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ email, projectId })
  });
  return response.json();
}
async function verifyOTP(email, otp) {
  const response = await fetch(`${DEFAULT_USERS_SERVICE_API_URL}/auth/verify-otp`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ email, otp })
  });
  return response.json();
}
export {
  DEFAULT_USERS_SERVICE_API_URL,
  SESSION_TOKEN_COOKIE_NAME,
  SUPPORTED_OAUTH_PROVIDERS,
  authMiddleware,
  deleteSession,
  exchangeCodeForSessionToken,
  getCurrentUser,
  getOAuthRedirectUrl,
  sendOTP,
  verifyOTP
};
//# sourceMappingURL=@hey-boss_users-service_backend.js.map
