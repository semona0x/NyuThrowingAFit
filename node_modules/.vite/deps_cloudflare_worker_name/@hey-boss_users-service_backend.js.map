{
  "version": 3,
  "sources": ["../../hono/dist/helper/factory/index.js", "../../@hey-boss/users-service/dist/backend.js"],
  "sourcesContent": ["// src/helper/factory/index.ts\nimport { Hono } from \"../../hono.js\";\nvar Factory = class {\n  initApp;\n  #defaultAppOptions;\n  constructor(init) {\n    this.initApp = init?.initApp;\n    this.#defaultAppOptions = init?.defaultAppOptions;\n  }\n  createApp = (options) => {\n    const app = new Hono(\n      options && this.#defaultAppOptions ? { ...this.#defaultAppOptions, ...options } : options ?? this.#defaultAppOptions\n    );\n    if (this.initApp) {\n      this.initApp(app);\n    }\n    return app;\n  };\n  createMiddleware = (middleware) => middleware;\n  createHandlers = (...handlers) => {\n    return handlers.filter((handler) => handler !== void 0);\n  };\n};\nvar createFactory = (init) => new Factory(init);\nvar createMiddleware = (middleware) => middleware;\nexport {\n  Factory,\n  createFactory,\n  createMiddleware\n};\n", "/// <reference types=\"hono\" />\nimport { getCookie } from \"hono/cookie\";\nimport { createMiddleware } from \"hono/factory\";\nimport { HTTPException } from \"hono/http-exception\";\nexport const DEFAULT_USERS_SERVICE_API_URL = \"https://user-server.dev-73d.workers.dev\";\nexport const SESSION_TOKEN_COOKIE_NAME = \"heyboss_session_token\";\nexport const SUPPORTED_OAUTH_PROVIDERS = [\"google\"];\n/**\n * Fetch the OAuth redirect URL from the Mocha Users Service.\n * @param provider - The OAuth provider to use (currently only \"google\" is supported)\n * @param options - Configuration options including origin URL\n * @returns The redirect URL to initiate the OAuth flow\n */\nexport async function getOAuthRedirectUrl(provider, options) {\n    if (!SUPPORTED_OAUTH_PROVIDERS.includes(provider)) {\n        throw new Error(`Unsupported OAuth provider: ${provider}`);\n    }\n    const response = await fetch(`${DEFAULT_USERS_SERVICE_API_URL}/oauth/${provider}/redirect_url?originUrl=${options.originUrl}`, {\n        method: \"GET\",\n        headers: {\n            \"Content-Type\": \"application/json\",\n        },\n    });\n    if (!response.ok) {\n        throw new Error(`Failed to get redirect URL for provider ${provider}: ${response.statusText}`);\n    }\n    const { redirectUrl } = await response.json();\n    return redirectUrl;\n}\n/**\n * Exchanges a code for a session token using the Mocha Users Service.\n * @param code - The OAuth code received after successful authentication\n * @returns The session token to use for authenticated requests\n */\nexport async function exchangeCodeForSessionToken(code, projectId = \"\") {\n    const response = await fetch(`${DEFAULT_USERS_SERVICE_API_URL}/sessions`, {\n        method: \"POST\",\n        headers: {\n            \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify({ code, projectId }),\n    });\n    if (!response.ok) {\n        throw new Error(`Failed to exchange code for session token: ${response.statusText}`);\n    }\n    const { sessionToken } = await response.json();\n    return sessionToken;\n}\n/**\n * Fetch the current user by their session token from the Mocha Users Service.\n * @param sessionToken - The session token obtained from exchangeCodeForSessionToken\n * @returns The user object or null if the session is invalid\n */\nexport async function getCurrentUser(sessionToken) {\n    const response = await fetch(`${DEFAULT_USERS_SERVICE_API_URL}/users/me`, {\n        method: \"GET\",\n        headers: {\n            Authorization: `Bearer ${sessionToken}`,\n        },\n    });\n    if (!response.ok) {\n        return null;\n    }\n    const { data: user } = await response.json();\n    return user;\n}\n/**\n * Delete the current session in the Mocha Users Service when logging out.\n * @param sessionToken - The users session token from their cookie.\n */\nexport async function deleteSession(sessionToken) {\n    await fetch(`${DEFAULT_USERS_SERVICE_API_URL}/sessions`, {\n        method: \"DELETE\",\n        headers: {\n            Authorization: `Bearer ${sessionToken}`,\n        },\n    });\n}\n/**\n * Hono middleware that authenticates requests against the Mocha Users Service.\n *\n * This middleware requests the current user using the session token stored in\n * cookies. If the request fails to return a valid user object, the middleware\n * throws an HTTPException with status 401. On success, it sets the authenticated\n * user in the Hono context for use in subsequent route handlers.\n *\n * Use this to protect routes and load the current user.\n *\n * @throws {HTTPException} 401 - When session token is invalid or not provided\n *\n * @example\n *\n * // Fetch the authenticated user's todos.\n * // Doesn't execute if the user is not authenticated.\n * app.get(\"/api/todos\", authMiddleware, async (c) => {\n *   const user = c.get(\"user\");\n *\n *   const { results } = await c.env.DB.prepare(\n *     \"SELECT * FROM todos WHERE user_id = ? ORDER BY created_at DESC\"\n *   )\n *     .bind(user.id)\n *     .all();\n *\n *   return c.json(results);\n * });\n */\nexport const authMiddleware = createMiddleware(async (c, next) => {\n    const sessionToken = getCookie(c, SESSION_TOKEN_COOKIE_NAME);\n    if (typeof sessionToken !== \"string\") {\n        return c.json({ error: \"Unauthorized\" }, 401);\n    }\n    const user = await getCurrentUser(sessionToken);\n    if (!user) {\n        throw new HTTPException(401, { message: \"Invalid session token\" });\n    }\n    c.set(\"user\", user);\n    await next();\n});\nexport async function sendOTP(email, projectId) {\n    const response = await fetch(`${DEFAULT_USERS_SERVICE_API_URL}/auth/send-otp`, {\n        method: \"POST\",\n        headers: {\n            \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify({ email, projectId }),\n    });\n    return response.json();\n}\nexport async function verifyOTP(email, otp) {\n    const response = await fetch(`${DEFAULT_USERS_SERVICE_API_URL}/auth/verify-otp`, {\n        method: \"POST\",\n        headers: {\n            \"Content-Type\": \"application/json\",\n        },\n        body: JSON.stringify({ email, otp }),\n    });\n    return response.json();\n}\n"],
  "mappings": ";;;;;;;;;;AAwBA,IAAI,mBAAmB,CAAC,eAAe;;;ACpBhC,IAAM,gCAAgC;AACtC,IAAM,4BAA4B;AAClC,IAAM,4BAA4B,CAAC,QAAQ;AAOlD,eAAsB,oBAAoB,UAAU,SAAS;AACzD,MAAI,CAAC,0BAA0B,SAAS,QAAQ,GAAG;AAC/C,UAAM,IAAI,MAAM,+BAA+B,QAAQ,EAAE;AAAA,EAC7D;AACA,QAAM,WAAW,MAAM,MAAM,GAAG,6BAA6B,UAAU,QAAQ,2BAA2B,QAAQ,SAAS,IAAI;AAAA,IAC3H,QAAQ;AAAA,IACR,SAAS;AAAA,MACL,gBAAgB;AAAA,IACpB;AAAA,EACJ,CAAC;AACD,MAAI,CAAC,SAAS,IAAI;AACd,UAAM,IAAI,MAAM,2CAA2C,QAAQ,KAAK,SAAS,UAAU,EAAE;AAAA,EACjG;AACA,QAAM,EAAE,YAAY,IAAI,MAAM,SAAS,KAAK;AAC5C,SAAO;AACX;AAMA,eAAsB,4BAA4B,MAAM,YAAY,IAAI;AACpE,QAAM,WAAW,MAAM,MAAM,GAAG,6BAA6B,aAAa;AAAA,IACtE,QAAQ;AAAA,IACR,SAAS;AAAA,MACL,gBAAgB;AAAA,IACpB;AAAA,IACA,MAAM,KAAK,UAAU,EAAE,MAAM,UAAU,CAAC;AAAA,EAC5C,CAAC;AACD,MAAI,CAAC,SAAS,IAAI;AACd,UAAM,IAAI,MAAM,8CAA8C,SAAS,UAAU,EAAE;AAAA,EACvF;AACA,QAAM,EAAE,aAAa,IAAI,MAAM,SAAS,KAAK;AAC7C,SAAO;AACX;AAMA,eAAsB,eAAe,cAAc;AAC/C,QAAM,WAAW,MAAM,MAAM,GAAG,6BAA6B,aAAa;AAAA,IACtE,QAAQ;AAAA,IACR,SAAS;AAAA,MACL,eAAe,UAAU,YAAY;AAAA,IACzC;AAAA,EACJ,CAAC;AACD,MAAI,CAAC,SAAS,IAAI;AACd,WAAO;AAAA,EACX;AACA,QAAM,EAAE,MAAM,KAAK,IAAI,MAAM,SAAS,KAAK;AAC3C,SAAO;AACX;AAKA,eAAsB,cAAc,cAAc;AAC9C,QAAM,MAAM,GAAG,6BAA6B,aAAa;AAAA,IACrD,QAAQ;AAAA,IACR,SAAS;AAAA,MACL,eAAe,UAAU,YAAY;AAAA,IACzC;AAAA,EACJ,CAAC;AACL;AA6BO,IAAM,iBAAiB,iBAAiB,OAAO,GAAG,SAAS;AAC9D,QAAM,eAAe,UAAU,GAAG,yBAAyB;AAC3D,MAAI,OAAO,iBAAiB,UAAU;AAClC,WAAO,EAAE,KAAK,EAAE,OAAO,eAAe,GAAG,GAAG;AAAA,EAChD;AACA,QAAM,OAAO,MAAM,eAAe,YAAY;AAC9C,MAAI,CAAC,MAAM;AACP,UAAM,IAAI,cAAc,KAAK,EAAE,SAAS,wBAAwB,CAAC;AAAA,EACrE;AACA,IAAE,IAAI,QAAQ,IAAI;AAClB,QAAM,KAAK;AACf,CAAC;AACD,eAAsB,QAAQ,OAAO,WAAW;AAC5C,QAAM,WAAW,MAAM,MAAM,GAAG,6BAA6B,kBAAkB;AAAA,IAC3E,QAAQ;AAAA,IACR,SAAS;AAAA,MACL,gBAAgB;AAAA,IACpB;AAAA,IACA,MAAM,KAAK,UAAU,EAAE,OAAO,UAAU,CAAC;AAAA,EAC7C,CAAC;AACD,SAAO,SAAS,KAAK;AACzB;AACA,eAAsB,UAAU,OAAO,KAAK;AACxC,QAAM,WAAW,MAAM,MAAM,GAAG,6BAA6B,oBAAoB;AAAA,IAC7E,QAAQ;AAAA,IACR,SAAS;AAAA,MACL,gBAAgB;AAAA,IACpB;AAAA,IACA,MAAM,KAAK,UAAU,EAAE,OAAO,IAAI,CAAC;AAAA,EACvC,CAAC;AACD,SAAO,SAAS,KAAK;AACzB;",
  "names": []
}
