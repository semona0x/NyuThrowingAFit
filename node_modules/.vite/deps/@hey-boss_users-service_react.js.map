{
  "version": 3,
  "sources": ["../../@hey-boss/users-service/dist/react.js"],
  "sourcesContent": ["import { jsx as _jsx } from \"react/jsx-runtime\";\nimport { createContext, useCallback, useContext, useEffect, useRef, useState, } from \"react\";\nconst AuthContext = createContext(null);\n// 添加弹窗相关常量\nconst POPUP_WIDTH = 500;\nconst POPUP_HEIGHT = 600;\n/**\n * A React context provider that manages authentication state and related actions.\n * Install this at the top of the React component tree to provide authentication\n * and user management functionality. This is needed for the `useAuth` hook to work.\n *\n * This will always fetch the `user` object on mount.\n *\n * @example\n * import { AuthProvider } from '@hey-boss/users-service/react';\n *\n * // React Router example\n * export default function App() {\n *   return (\n *     <AuthProvider>\n *       <Router>\n *         <Routes>\n *           <Route path=\"/\" element={<HomePage />} />\n *           <Route path=\"/auth/callback\" element={<AuthCallbackPage />} />\n *         </Routes>\n *       </Router>\n *     </AuthProvider>\n *   );\n * }\n */\nexport function AuthProvider({ children }) {\n    const [user, setUser] = useState(null);\n    // Use these to dedup requests. This is mostly for avoiding multiple\n    // calls from useEffects in dev, which could cause wonky behavior with\n    // the loading states or problems when exchanging code for session token.\n    const userRef = useRef(null);\n    const exchangeRef = useRef(null);\n    const popupRef = useRef(null);\n    const popupPromiseRef = useRef(null);\n    const [isPending, setIsPending] = useState(true);\n    const [isFetching, setIsFetching] = useState(false);\n    const fetchUser = useCallback(async () => {\n        if (userRef.current)\n            return userRef.current;\n        userRef.current = (async () => {\n            setIsFetching(true);\n            try {\n                const response = await fetch(\"/api/users/me\");\n                if (!response.ok) {\n                    throw new Error(`Failed to fetch user: API responded with HTTP status ${response.status}`);\n                }\n                const user = await response.json();\n                setUser(user);\n            }\n            catch (error) {\n                throw error;\n            }\n            finally {\n                setIsFetching(false);\n                userRef.current = null;\n            }\n        })();\n        return userRef.current;\n    }, []);\n    const logout = useCallback(async () => {\n        try {\n            setUser(null);\n            await fetch(\"/api/logout\");\n        }\n        catch (error) {\n            console.error(\"Failed to logout:\", error);\n        }\n    }, []);\n    const redirectToLogin = useCallback(async () => {\n        try {\n            const originUrl = new URL(window.location.href).origin;\n            const response = await fetch(`/api/oauth/google/redirect_url?originUrl=${originUrl}`);\n            if (!response.ok) {\n                throw new Error(`Failed to get login redirect URL: API responded with HTTP status ${response.status}`);\n            }\n            const { redirectUrl } = await response.json();\n            window.location.href = redirectUrl;\n        }\n        catch (error) {\n            console.error(error);\n        }\n    }, []);\n    // 弹窗登录函数\n    const popupLogin = useCallback(async () => {\n        try {\n            // 如果已经有弹窗打开，直接返回现有promise\n            if (popupPromiseRef.current) {\n                return popupPromiseRef.current;\n            }\n            const originUrl = new URL(window.location.href).origin;\n            const response = await fetch(`/api/oauth/google/redirect_url?originUrl=${originUrl}`);\n            if (!response.ok) {\n                throw new Error(`Failed to get login redirect URL: API responded with HTTP status ${response.status}`);\n            }\n            const { redirectUrl } = await response.json();\n            // 创建弹窗\n            const left = (window.screen.width - POPUP_WIDTH) / 2;\n            const top = (window.screen.height - POPUP_HEIGHT) / 2;\n            popupPromiseRef.current = new Promise((resolve, reject) => {\n                // 打开弹窗\n                popupRef.current = window.open(redirectUrl, \"google-oauth\", `width=${POPUP_WIDTH},height=${POPUP_HEIGHT},left=${left},top=${top},scrollbars=yes,resizable=yes`);\n                if (!popupRef.current) {\n                    reject(new Error(\"Failed to open popup window\"));\n                    return;\n                }\n                // 添加标志位来跟踪是否已处理\n                let isProcessed = false;\n                let checkClosedInterval;\n                // 监听弹窗消息\n                const handleMessage = async (event) => {\n                    // 验证消息来源\n                    if (event.origin !== window.location.origin)\n                        return;\n                    if (event.data.type === \"GOOGLE_OAUTH_SUCCESS\") {\n                        const { code } = event.data;\n                        isProcessed = true; // 标记为已处理\n                        try {\n                            // 交换code获取session token\n                            await exchangeCodeForSessionToken(code);\n                            resolve();\n                        }\n                        catch (error) {\n                            reject(error);\n                        }\n                        finally {\n                            cleanup();\n                        }\n                    }\n                    else if (event.data.type === \"GOOGLE_OAUTH_ERROR\") {\n                        isProcessed = true; // 标记为已处理\n                        reject(new Error(event.data.error || \"OAuth authorization failed\"));\n                        cleanup();\n                    }\n                };\n                // 检查弹窗是否关闭\n                const checkClosed = () => {\n                    if (popupRef.current && popupRef.current.closed && !isProcessed) {\n                        // 只有在未处理的情况下才认为是用户取消\n                        reject(new Error(\"User cancelled the login process\"));\n                        cleanup();\n                    }\n                    else if (popupRef.current && !popupRef.current.closed) {\n                        // 继续检查，直到弹窗关闭或处理完成\n                        checkClosedInterval = setTimeout(checkClosed, 1000);\n                    }\n                };\n                // 清理函数\n                const cleanup = () => {\n                    window.removeEventListener(\"message\", handleMessage);\n                    if (checkClosedInterval) {\n                        clearTimeout(checkClosedInterval);\n                    }\n                    if (popupRef.current && !popupRef.current.closed) {\n                        popupRef.current.close();\n                    }\n                    popupRef.current = null;\n                    popupPromiseRef.current = null;\n                };\n                // 添加事件监听\n                window.addEventListener(\"message\", handleMessage);\n                window.addEventListener(\"storage\", async (event) => {\n                    isProcessed = true;\n                    if (event.key === \"GOOGLE_OAUTH_SUCCESS\" && event.newValue) {\n                        try {\n                            // 交换code获取session token\n                            await exchangeCodeForSessionToken(event.newValue);\n                            resolve();\n                        }\n                        catch (error) {\n                            reject(error);\n                        }\n                        finally {\n                            cleanup();\n                            localStorage.removeItem(\"GOOGLE_OAUTH_SUCCESS\");\n                        }\n                    }\n                    if (event.key === \"GOOGLE_OAUTH_ERROR\" && event.newValue) {\n                        reject(new Error(event.newValue || \"OAuth authorization failed\"));\n                        cleanup();\n                        localStorage.removeItem(\"GOOGLE_OAUTH_ERROR\");\n                    }\n                });\n                checkClosed();\n            });\n            return popupPromiseRef.current;\n        }\n        catch (error) {\n            console.error(\"Popup login failed:\", error);\n            throw error;\n        }\n    }, [fetchUser]);\n    const exchangeCodeForSessionToken = useCallback((code) => {\n        // Ensure we only exchange the code once. In dev, useEffect will run\n        // twice, so we need to reuse this promise to avoid multiple exchanges\n        // which would otherwise result in a failed request. The failed request\n        // sometimes causes the entire flow to break.\n        if (exchangeRef.current)\n            return exchangeRef.current;\n        exchangeRef.current = (async (code) => {\n            try {\n                const response = await fetch(\"/api/sessions\", {\n                    method: \"POST\",\n                    headers: {\n                        \"Content-Type\": \"application/json\",\n                    },\n                    body: JSON.stringify({ code }),\n                });\n                if (!response.ok) {\n                    throw new Error(`Failed to exchange code for session token: API responded with HTTP status ${response.status}`);\n                }\n                // Refetch user after successful code exchange to populate user state\n                await fetchUser();\n            }\n            catch (error) {\n                console.error(error);\n            }\n            finally {\n                exchangeRef.current = null;\n            }\n        })(code);\n        return exchangeRef.current;\n    }, [fetchUser]);\n    // 向父窗口发送OAuth Code\n    const notifyParentWindowWithOAuthCode = () => {\n        const urlParams = new URLSearchParams(window.location.search);\n        const code = urlParams.get(\"code\");\n        const error = urlParams.get(\"error\");\n        const errorDescription = urlParams.get(\"error_description\");\n        if (!code && !error) {\n            throw new Error(\"No OAuth code or error found in URL parameters.\");\n        }\n        const handleSuccess = (successCode) => {\n            if (window.opener) {\n                window.opener.postMessage({ type: \"GOOGLE_OAUTH_SUCCESS\", code: successCode }, window.location.origin);\n            }\n            else {\n                localStorage.setItem(\"GOOGLE_OAUTH_SUCCESS\", successCode);\n            }\n        };\n        const handleError = (errorMsg) => {\n            if (window.opener) {\n                window.opener.postMessage({ type: \"GOOGLE_OAUTH_ERROR\", error: errorMsg }, window.location.origin);\n            }\n            else {\n                localStorage.setItem(\"GOOGLE_OAUTH_ERROR\", errorMsg);\n            }\n        };\n        if (code) {\n            handleSuccess(code);\n        }\n        else if (error) {\n            handleError(errorDescription || error);\n        }\n        window.close();\n    };\n    const sendOTP = useCallback(async (email) => {\n        const response = await fetch(\"/api/send-otp\", {\n            method: \"POST\",\n            headers: {\n                \"Content-Type\": \"application/json\",\n            },\n            body: JSON.stringify({ email }),\n        });\n        const data = await response.json();\n        if (data.error) {\n            throw new Error(data.error);\n        }\n        return data;\n    }, []);\n    const verifyOTP = useCallback(async (email, otp) => {\n        const response = await fetch(\"/api/verify-otp\", {\n            method: \"POST\",\n            headers: {\n                \"Content-Type\": \"application/json\",\n            },\n            body: JSON.stringify({ email, otp }),\n        });\n        return response.json().then((data) => {\n            if (data.error) {\n                throw new Error(data.error);\n            }\n            fetchUser();\n            return data;\n        });\n    }, []);\n    useEffect(() => {\n        fetchUser().then(() => setIsPending(false), () => setIsPending(false));\n    }, []);\n    const contextValue = {\n        user,\n        isPending,\n        isFetching,\n        fetchUser,\n        redirectToLogin,\n        popupLogin,\n        exchangeCodeForSessionToken,\n        notifyParentWindowWithOAuthCode,\n        logout,\n        sendOTP,\n        verifyOTP,\n    };\n    return _jsx(AuthContext.Provider, {\n        value: contextValue,\n        children: children,\n    });\n}\n/**\n * A React hook that provides the AuthContextValue.\n * @example\n * const { user } = useAuth();\n */\nexport function useAuth() {\n    const context = useContext(AuthContext);\n    if (!context) {\n        throw new Error(\"useAuth must be used within a AuthProvider\");\n    }\n    return context;\n}\n"],
  "mappings": "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",
  "names": ["user", "code", "_jsx"]
}
